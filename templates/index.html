<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Reminder App - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .reminder-card {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Header with Logout -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>SMS Reminder App</h1>
            <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
        </div>

        <div class="row">
            <!-- Patient Management -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h4>Patient Management</h4>
                    </div>
                    <div class="card-body">
                        <form id="patientForm" class="mb-4">
                            <div class="mb-3">
                                <label for="patientName" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="patientName" required>
                            </div>
                            <div class="mb-3">
                                <label for="patientPhone" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="patientPhone" placeholder="+1234567890" required>
                            </div>
                            <div class="mb-3">
                                <label for="patientEmail" class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="patientEmail">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Patient</button>
                        </form>

                        <div id="patientsList">
                            <!-- Patients will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Reminder -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h4>Schedule Reminder</h4>
                    </div>
                    <div class="card-body">
                        <form id="reminderForm">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Select Patient</label>
                                <select class="form-select" id="patientSelect" required>
                                    <option value="">Choose a patient...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="datetime" class="form-label">Schedule Time</label>
                                <input type="datetime-local" class="form-control" id="datetime" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Reminder</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reminders List -->
        <div class="card">
            <div class="card-header">
                <h4>Scheduled Reminders</h4>
            </div>
            <div class="card-body">
                <div id="remindersList"></div>
            </div>
        </div>
    </div>

    <script>
        // Logout function
        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Error logging out:', error);
            });
        }

        // Load and display patients
        function loadPatients() {
            fetch('/api/patients')
                .then(response => response.json())
                .then(data => {
                    // Update patients list
                    const patientsList = document.getElementById('patientsList');
                    patientsList.innerHTML = '<h5 class="mb-3">Registered Patients</h5>';
                    
                    if (data.patients.length === 0) {
                        patientsList.innerHTML += '<p class="text-muted">No patients registered yet.</p>';
                        return;
                    }

                    const list = document.createElement('div');
                    list.className = 'list-group';
                    data.patients.forEach(patient => {
                        list.innerHTML += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${patient.name}</h6>
                                        <small>üì± ${patient.phone_number}</small>
                                        ${patient.email ? `<br><small>‚úâÔ∏è ${patient.email}</small>` : ''}
                                    </div>
                                    <button onclick="deletePatient(${patient.id})" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    patientsList.appendChild(list);

                    // Update patient select in reminder form
                    const patientSelect = document.getElementById('patientSelect');
                    patientSelect.innerHTML = '<option value="">Choose a patient...</option>';
                    data.patients.forEach(patient => {
                        patientSelect.innerHTML += `
                            <option value="${patient.id}">${patient.name} (${patient.phone_number})</option>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading patients:', error);
                    if (error.message === 'Not authenticated') {
                        window.location.href = '/';
                    }
                });
        }

        // Add new patient
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('patientName').value,
                phone_number: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value || null
            };

            fetch('/api/patients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('patientForm').reset();
                    loadPatients();
                }
            })
            .catch(error => {
                console.error('Error creating patient:', error);
                alert('Error creating patient. Please try again.');
            });
        });

        // Delete patient
        function deletePatient(id) {
            if (confirm('Are you sure you want to delete this patient? All associated reminders will also be deleted.')) {
                fetch(`/api/patients/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        loadPatients();
                        loadReminders();
                    }
                })
                .catch(error => console.error('Error deleting patient:', error));
            }
        }

        // Initialize datetime input with current time
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('datetime').value = now.toISOString().slice(0, 16);

        // Load reminders
        function loadReminders() {
            fetch('/api/reminders')
                .then(response => response.json())
                .then(data => {
                    const remindersList = document.getElementById('remindersList');
                    remindersList.innerHTML = '';
                    
                    if (data.reminders.length === 0) {
                        remindersList.innerHTML = '<p class="text-muted">No reminders scheduled yet.</p>';
                        return;
                    }

                    data.reminders.forEach(reminder => {
                        const card = document.createElement('div');
                        card.className = 'card reminder-card';
                        card.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">üì± ${reminder.patient.name}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">
                                    ‚è∞ ${new Date(reminder.scheduled_time).toLocaleString()}<br>
                                    üìû ${reminder.patient.phone_number}
                                </h6>
                                <p class="card-text">${reminder.message}</p>
                                <span class="badge bg-${reminder.status === 'pending' ? 'warning' : 'success'}">${reminder.status}</span>
                                <button onclick="deleteReminder(${reminder.id})" class="btn btn-danger btn-sm float-end">Delete</button>
                            </div>
                        `;
                        remindersList.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading reminders:', error);
                    if (error.message === 'Not authenticated') {
                        window.location.href = '/';
                    }
                });
        }

        // Create reminder
        document.getElementById('reminderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                patient_id: document.getElementById('patientSelect').value,
                message: document.getElementById('message').value,
                scheduled_time: new Date(document.getElementById('datetime').value).toISOString()
            };

            fetch('/api/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.message);
                } else {
                    document.getElementById('reminderForm').reset();
                    document.getElementById('datetime').value = now.toISOString().slice(0, 16);
                    loadReminders();
                }
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                alert('Error creating reminder. Please try again.');
            });
        });

        // Delete reminder
        function deleteReminder(id) {
            if (confirm('Are you sure you want to delete this reminder?')) {
                fetch(`/api/reminders/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.message);
                    } else {
                        loadReminders();
                    }
                })
                .catch(error => console.error('Error deleting reminder:', error));
            }
        }

        // Initialize page
        loadPatients();
        loadReminders();
        // Refresh data every 30 seconds
        setInterval(() => {
            loadPatients();
            loadReminders();
        }, 30000);
    </script>
</body>
</html>
