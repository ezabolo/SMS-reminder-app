<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Reminder App - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .reminder-card {
            margin-bottom: 1rem;
        }
        .nav-tabs {
            margin-bottom: 1.5rem;
        }
        .tab-content {
            padding: 1rem 0;
        }
        .app-logo {
            height: 60px;
            margin-right: 20px;
        }
        .header-content {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Header with Logout -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="header-content">
                <img src="/static/logo.svg" alt="Artistic Family Dentistry Logo" class="app-logo">
                <h1>Appointment Reminder App</h1>
            </div>
            <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                    Appointments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
                    Patients
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            <!-- Appointments Tab -->
            <div class="tab-pane fade show active" id="appointments" role="tabpanel">
                <div class="row">
                    <!-- Schedule Appointment -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h4>Schedule Appointment</h4>
                            </div>
                            <div class="card-body">
                                <form id="reminderForm">
                                    <div class="mb-3">
                                        <label for="patientSelect" class="form-label">Select Patient</label>
                                        <select class="form-select" id="patientSelect" required>
                                            <option value="">Choose a patient...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="message" class="form-label">Message</label>
                                        <textarea class="form-control" id="message" rows="3" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="datetime" class="form-label">Schedule Time</label>
                                        <input type="datetime-local" class="form-control" id="datetime" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create Appointment</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments List -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4>Scheduled Appointments</h4>
                                    <div class="d-flex align-items-center">
                                        <input type="date" id="filterDate" class="form-control me-2">
                                        <button onclick="loadReminders()" class="btn btn-primary">Filter</button>
                                        <button onclick="clearDateFilter()" class="btn btn-outline-secondary ms-2">Clear</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="remindersList">
                                    <!-- Appointments will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patients Tab -->
            <div class="tab-pane fade" id="patients" role="tabpanel">
                <div class="row">
                    <!-- Add Patient Form -->
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h4>Add New Patient</h4>
                            </div>
                            <div class="card-body">
                                <form id="patientForm">
                                    <div class="mb-3">
                                        <label for="patientName" class="form-label">Patient Name</label>
                                        <input type="text" class="form-control" id="patientName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="patientPhone" class="form-label">Phone Number</label>
                                        <input type="text" class="form-control" id="patientPhone" placeholder="+1234567890" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="patientEmail" class="form-label">Email (Optional)</label>
                                        <input type="email" class="form-control" id="patientEmail">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Add Patient</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Patients List -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h4>Registered Patients</h4>
                            </div>
                            <div class="card-body">
                                <div id="patientsList">
                                    <!-- Patients will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Logout function
        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Error logging out:', error);
            });
        }

        // Load and display patients
        function loadPatients() {
            fetch('/api/patients')
                .then(response => response.json())
                .then(data => {
                    // Update patients list
                    const patientsList = document.getElementById('patientsList');
                    patientsList.innerHTML = '';
                    
                    if (data.patients.length === 0) {
                        patientsList.innerHTML = '<p class="text-muted">No patients registered yet.</p>';
                        return;
                    }

                    const list = document.createElement('div');
                    list.className = 'list-group';
                    data.patients.forEach(patient => {
                        list.innerHTML += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${patient.name}</h6>
                                        <small>üì± ${patient.phone_number}</small>
                                        ${patient.email ? `<br><small>‚úâÔ∏è ${patient.email}</small>` : ''}
                                    </div>
                                    <button onclick="deletePatient(${patient.id})" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    patientsList.appendChild(list);

                    // Update patient select in reminder form
                    const patientSelect = document.getElementById('patientSelect');
                    patientSelect.innerHTML = '<option value="">Choose a patient...</option>';
                    data.patients.forEach(patient => {
                        patientSelect.innerHTML += `
                            <option value="${patient.id}">${patient.name} (${patient.phone_number})</option>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading patients:', error);
                    if (error.message === 'Not authenticated') {
                        window.location.href = '/';
                    }
                });
        }

        // Add new patient
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('patientName').value,
                phone_number: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value || null
            };

            fetch('/api/patients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('patientForm').reset();
                    loadPatients();
                }
            })
            .catch(error => {
                console.error('Error creating patient:', error);
                alert('Error creating patient. Please try again.');
            });
        });

        // Delete patient
        function deletePatient(id) {
            if (confirm('Are you sure you want to delete this patient? All associated appointments will also be deleted.')) {
                fetch(`/api/patients/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        loadPatients();
                        loadReminders();
                    }
                })
                .catch(error => console.error('Error deleting patient:', error));
            }
        }

        // Initialize datetime input with current time
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('datetime').value = now.toISOString().slice(0, 16);

        // Initialize date filter with today's date
        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        document.getElementById('filterDate').value = today.toISOString().split('T')[0];

        // Clear date filter
        function clearDateFilter() {
            document.getElementById('filterDate').value = '';
            loadReminders();
        }

        // Load reminders with date filter
        function loadReminders() {
            const filterDate = document.getElementById('filterDate').value;
            const url = filterDate ? `/api/reminders?date=${filterDate}` : '/api/reminders';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const remindersList = document.getElementById('remindersList');
                    remindersList.innerHTML = '';
                    
                    if (data.reminders.length === 0) {
                        remindersList.innerHTML = '<p class="text-muted">No appointments scheduled for this date.</p>';
                        return;
                    }

                    // Group reminders by time slots
                    const timeSlots = {
                        morning: { title: 'Morning (12 AM - 11:59 AM)', reminders: [] },
                        afternoon: { title: 'Afternoon (12 PM - 5:59 PM)', reminders: [] },
                        evening: { title: 'Evening (6 PM - 11:59 PM)', reminders: [] }
                    };

                    data.reminders.forEach(reminder => {
                        const time = new Date(reminder.scheduled_time);
                        const hour = time.getHours();
                        
                        if (hour < 12) {
                            timeSlots.morning.reminders.push(reminder);
                        } else if (hour < 18) {
                            timeSlots.afternoon.reminders.push(reminder);
                        } else {
                            timeSlots.evening.reminders.push(reminder);
                        }
                    });

                    // Create sections for each time slot
                    Object.values(timeSlots).forEach(slot => {
                        if (slot.reminders.length > 0) {
                            const section = document.createElement('div');
                            section.className = 'mb-4';
                            section.innerHTML = `<h5 class="mb-3">${slot.title}</h5>`;
                            
                            const remindersContainer = document.createElement('div');
                            slot.reminders.forEach(reminder => {
                                const time = new Date(reminder.scheduled_time);
                                const card = document.createElement('div');
                                card.className = 'card reminder-card';
                                card.innerHTML = `
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 class="card-title">
                                                    üïí ${time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                    - ${reminder.patient.name}
                                                </h5>
                                                <h6 class="card-subtitle mb-2 text-muted">
                                                    üìû ${reminder.patient.phone_number}
                                                </h6>
                                                <p class="card-text">${reminder.message}</p>
                                                <span class="badge bg-${reminder.status === 'pending' ? 'warning' : 'success'}">${reminder.status}</span>
                                            </div>
                                            <button onclick="deleteReminder(${reminder.id})" class="btn btn-danger btn-sm">Delete</button>
                                        </div>
                                    </div>
                                `;
                                remindersContainer.appendChild(card);
                            });
                            section.appendChild(remindersContainer);
                            remindersList.appendChild(section);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading reminders:', error);
                    if (error.message === 'Not authenticated') {
                        window.location.href = '/';
                    }
                });
        }

        // Create reminder
        document.getElementById('reminderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const datetimeInput = document.getElementById('datetime').value;
            const scheduledTime = new Date(datetimeInput);
            
            const data = {
                patient_id: document.getElementById('patientSelect').value,
                message: document.getElementById('message').value,
                scheduled_time: scheduledTime.toISOString()
            };

            fetch('/api/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('reminderForm').reset();
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById('datetime').value = now.toISOString().slice(0, 16);
                    loadReminders();
                }
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                alert('Error creating reminder. Please try again.');
            });
        });

        // Delete reminder
        function deleteReminder(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                fetch(`/api/reminders/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        loadReminders();
                    }
                })
                .catch(error => console.error('Error deleting reminder:', error));
            }
        }

        // Initialize page
        loadPatients();
        loadReminders();
        
        // Refresh data every 30 seconds
        setInterval(() => {
            loadPatients();
            loadReminders();
        }, 30000);

        // Update patients list when switching to the Patients tab
        document.getElementById('patients-tab').addEventListener('shown.bs.tab', function (e) {
            loadPatients();
        });
    </script>
</body>
</html>
